#
# GitHub Action: E2E Tests
#
# This workflow is triggered on pushes to main and renovate branches, as well as
# pull requests. It runs E2E Tests to ensure the code is working.
#
name: E2E Tests

on:
  push:
    branches:
      - main
      - 'renovate/**'
  pull_request:

env:
  # Required environment variables for the E2E test
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  OPENAI_API_KEY: PLACEHOLDER

jobs:
  test:
    name: Run on Ubuntu
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: testworkflows

    steps:
      - name: Clone the code
        uses: 'actions/checkout@v5'

      - name: Install uv
        uses: 'astral-sh/setup-uv@v6'
        with:
          version: "0.8.17"
          enable-cache: true

      - name: Setup Python
        uses: 'actions/setup-python@v6'
        with:
          python-version-file: "testworkflows/.python-version"

      - name: Install Dependencies
        run: uv sync --all-packages

      - name: Set up Kubernetes (kind)
        uses: 'helm/kind-action@v1'
        with:
          cluster_name: testbench-cluster

      - name: Install Tilt
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
          tilt version

      - name: Start test data server
        run: uv run python -m http.server 8000 --directory tests/test_data &

      - name: Start Tiltfile services
        run: tilt ci
        working-directory: .

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          kubectl wait --for=condition=ready pod -l app=weather-agent --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=ai-gateway-litellm --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=lgtm --timeout=300s || true
          
          echo "Checking service status..."
          kubectl get pods -A
          
          echo "Waiting for test-data-server (HTTP server on port 8000)..."
          curl --retry 30 --retry-delay 2 --retry-connrefused -f http://localhost:8000/dataset.json > /dev/null

      - name: Running Test e2e
        run: uv run poe test_e2e
