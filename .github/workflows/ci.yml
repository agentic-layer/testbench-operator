name: Check

on:
  push:
    branches:
      - main
      - 'renovate/**'
  pull_request:

jobs:
  python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: 'actions/checkout@v6'

      - name: Install uv
        uses: 'astral-sh/setup-uv@v7'
        with:
          version: "0.9.26"
          enable-cache: true

      - name: Install Dependencies
        run: uv sync

      - name: Run Checks
        run: uv run poe check

      - name: Run Tests
        run: uv run poe test

  push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image-tags: ${{ steps.build-push.outputs.image-tags }}

    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v5'
        with:
          fetch-depth: 0

      - name: Build and push Docker image
        id: build-push
        uses: ./.github/actions/build-push-image
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  helm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: 'actions/checkout@v6'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Lint Helm Chart
        run: helm lint chart/

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: push
    timeout-minutes: 30
    env:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

    steps:
      - name: Checkout
        uses: 'actions/checkout@v6'

      - name: Extract image tag
        id: extract-tag
        run: |
          # Get the first tag from the newline-separated list
          IMAGE_TAG=$(echo "${{ needs.push.outputs.image-tags }}" | head -n 1)
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image: ${IMAGE_TAG}"

      - name: Set up Kubernetes (kind)
        uses: 'helm/kind-action@v1'
        with:
          cluster_name: 'kind'

      - name: Install Tilt
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
          tilt version

      - name: Run Tilt CI
        run: |
          # The tilt setup is a bit flaky on a fresh startup, so we retry a few times
          for i in {1..5}; do
            tilt ci && break
            if [ $i -eq 5 ]; then
              echo "Tilt CI failed after 5 attempts, exiting."
              exit 1
            fi
            echo "Tilt CI failed, retrying... ($i/4)"

            # Clean up stuck Helm releases before retrying
            helm rollback testkube -n testkube 2>/dev/null || helm uninstall testkube -n testkube 2>/dev/null || true

            # Wait a bit for resources to stabilize
            sleep 10
          done

      - name: Setup Testkube CLI
        uses: kubeshop/setup-testkube@v1

      - name: Run Test Workflow
        run: |
          testkube run testworkflow multi-turn-workflow --watch
